import * as tslib_1 from "tslib";
import { Directive, ElementRef, Input } from '@angular/core';
import { combineLatest, ReplaySubject, Subject } from 'rxjs';
import { MathJaxService } from './math-jax.service';
import { map } from 'rxjs/operators';
/**
 * Typeset the content or expressions using MathJax library.
 */
let MathJaxDirective = class MathJaxDirective {
    constructor(el, service) {
        /**
         * Observes the change of the input expression.
         */
        this.expressionChangeSubject = new ReplaySubject();
        /**
         * Observes the completion of the initial MathJax typesetting.
         */
        this.mathJaxTypesetSubject = new Subject();
        this.mathJaxHub$ = service.MathJaxHub$;
        this.element = el.nativeElement;
        this.typesetSubscription = combineLatest([this.mathJaxHub$, this.mathJaxTypesetSubject])
            .subscribe(() => {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, this.element]);
        });
        this.allJax$ = combineLatest([this.mathJaxHub$, this.mathJaxTypesetSubject]).pipe(map(() => MathJax.Hub.getAllJax(this.element)));
        this.expressionChangeSubscription = combineLatest([this.allJax$, this.expressionChangeSubject])
            .subscribe(([jax, updateValue]) => updateValue.forEach(v => MathJax.Hub.Queue(() => {
            // Stop pushing messages to the queue when the component is being destroyed.
            if (!this.isDestroying) {
                return jax[v.order].Text(v.value);
            }
        })));
    }
    ngAfterViewInit() {
        this.hubSubscription = this.mathJaxHub$
            .subscribe(() => {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, this.element]);
            MathJax.Hub.Queue(['MathJaxTypeset', this]);
        });
    }
    /**
     * Explicitly trigger the MathJax typeset process.
     *
     * This is useful if the content is loaded dynamically.
     */
    MathJaxTypeset() {
        this.mathJaxTypesetSubject.next();
    }
    ngOnChanges(changes) {
        const expressions = changes.MathJaxExpressions;
        // Shortcut if there's nothing to update.
        if (!(expressions.currentValue instanceof Array)) {
            return;
        }
        // Update only the changed expressions.
        const updateValues = expressions.currentValue
            .map((cv, i) => (expressions.previousValue ? expressions.previousValue[i] !== cv : true) ?
            {
                value: expressions.currentValue[i],
                order: i
            }
            : undefined)
            .filter(v => v);
        this.expressionChangeSubject.next(updateValues);
    }
    ngOnDestroy() {
        this.isDestroying = true;
        this.expressionChangeSubscription.unsubscribe();
        this.hubSubscription.unsubscribe();
        this.typesetSubscription.unsubscribe();
        this.mathJaxTypesetSubject.complete();
        this.expressionChangeSubject.complete();
    }
};
tslib_1.__decorate([
    Input('mathjax'),
    tslib_1.__metadata("design:type", Array)
], MathJaxDirective.prototype, "MathJaxExpressions", void 0);
MathJaxDirective = tslib_1.__decorate([
    Directive({
        selector: 'mathjax, [mathjax]'
    }),
    tslib_1.__metadata("design:paramtypes", [ElementRef, MathJaxService])
], MathJaxDirective);
export { MathJaxDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aC1qYXguZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW1hdGhqYXgvIiwic291cmNlcyI6WyJzcmMvYXBwL21hdGgtamF4L21hdGgtamF4LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBSUEsT0FBTyxFQUFpQixTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBdUMsTUFBTSxlQUFlLENBQUM7QUFDakgsT0FBTyxFQUFFLGFBQWEsRUFBYyxhQUFhLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUN2RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JDOztHQUVHO0FBSUgsSUFBYSxnQkFBZ0IsR0FBN0IsTUFBYSxnQkFBZ0I7SUE0QjNCLFlBQVksRUFBYyxFQUFFLE9BQXVCO1FBakJuRDs7V0FFRztRQUNLLDRCQUF1QixHQUFHLElBQUksYUFBYSxFQUF5QixDQUFDO1FBQzdFOztXQUVHO1FBQ2MsMEJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQVcxRCxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDO1FBRWhDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2FBQ3JGLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDZCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FBQyxDQUFDO1FBRUwsSUFBSSxDQUFDLE9BQU8sR0FBRyxhQUFhLENB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QUMsU0FBUyxDQUFDOzs0REFDbUI7QUFMekIsZ0JBQWdCO0lBSDVCLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxvQkFBb0I7S0FDL0IsQ0FBQzs2Q0E2QmdCLFVBQVUsRUFBVyxjQUFjO0dBNUJ4QyxnQkFBZ0IsQ0FtRzVCO1NBbkdZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGF1dGhvciBkYXZpZHNoZW44NFxuICovXG5pbXBvcnQgeyBVcGRhdGVWYWx1ZSB9IGZyb20gJy4vZG9tYWluL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbnB1dCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTWF0aEpheFNlcnZpY2UgfSBmcm9tICcuL21hdGgtamF4LnNlcnZpY2UnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5cbi8qKlxuICogVHlwZXNldCB0aGUgY29udGVudCBvciBleHByZXNzaW9ucyB1c2luZyBNYXRoSmF4IGxpYnJhcnkuXG4gKi9cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ21hdGhqYXgsIFttYXRoamF4XSdcbn0pXG5leHBvcnQgY2xhc3MgTWF0aEpheERpcmVjdGl2ZSBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgLyoqXG4gICAqIEFuIGFycmF5IG9mIGlucHV0IE1hdGhKYXggZXhwcmVzc2lvbnMuXG4gICAqL1xuICBASW5wdXQoJ21hdGhqYXgnKVxuICBwdWJsaWMgTWF0aEpheEV4cHJlc3Npb25zOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXRoSmF4SHViJDogT2JzZXJ2YWJsZTxhbnk+O1xuICAvKipcbiAgICogVGhlIGFzc29jaWF0ZWQgbmF0aXZlIGVsZW1lbnQuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICAvKipcbiAgICogT2JzZXJ2ZXMgdGhlIGNoYW5nZSBvZiB0aGUgaW5wdXQgZXhwcmVzc2lvbi5cbiAgICovXG4gIHByaXZhdGUgZXhwcmVzc2lvbkNoYW5nZVN1YmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdDxVcGRhdGVWYWx1ZTxzdHJpbmc+W10+KCk7XG4gIC8qKlxuICAgKiBPYnNlcnZlcyB0aGUgY29tcGxldGlvbiBvZiB0aGUgaW5pdGlhbCBNYXRoSmF4IHR5cGVzZXR0aW5nLlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBtYXRoSmF4VHlwZXNldFN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXhwcmVzc2lvbkNoYW5nZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICAvKipcbiAgICogT2JzZXJ2ZSB0aGUgcmVhZGluZXNzIG9mIGFsbCB0aGUgSmF4IGluc3RhbmNlcyBpbiB0aGUgZWxlbWVudC5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgYWxsSmF4JDogT2JzZXJ2YWJsZTxhbnlbXT47XG4gIHByaXZhdGUgcmVhZG9ubHkgdHlwZXNldFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIGh1YlN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIGlzRGVzdHJveWluZzogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihlbDogRWxlbWVudFJlZiwgc2VydmljZTogTWF0aEpheFNlcnZpY2UpIHtcbiAgICB0aGlzLm1hdGhKYXhIdWIkID0gc2VydmljZS5NYXRoSmF4SHViJDtcbiAgICB0aGlzLmVsZW1lbnQgPSBlbC5uYXRpdmVFbGVtZW50O1xuXG4gICAgdGhpcy50eXBlc2V0U3Vic2NyaXB0aW9uID0gY29tYmluZUxhdGVzdChbdGhpcy5tYXRoSmF4SHViJCwgdGhpcy5tYXRoSmF4VHlwZXNldFN1YmplY3RdKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIE1hdGhKYXguSHViLlF1ZXVlKFsnVHlwZXNldCcsIE1hdGhKYXguSHViLCB0aGlzLmVsZW1lbnRdKTtcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5hbGxKYXgkID0gY29tYmluZUxhdGVzdChbdGhpcy5tYXRoSmF4SHViJCwgdGhpcy5tYXRoSmF4VHlwZXNldFN1YmplY3RdKS5waXBlKFxuICAgICAgbWFwKCgpID0+IE1hdGhKYXguSHViLmdldEFsbEpheCh0aGlzLmVsZW1lbnQpKVxuICAgICk7XG5cbiAgICB0aGlzLmV4cHJlc3Npb25DaGFuZ2VTdWJzY3JpcHRpb24gPSBjb21iaW5lTGF0ZXN0KFt0aGlzLmFsbEpheCQsIHRoaXMuZXhwcmVzc2lvbkNoYW5nZVN1YmplY3RdKVxuICAgICAgLnN1YnNjcmliZSgoW2pheCwgdXBkYXRlVmFsdWVdKSA9PlxuICAgICAgICB1cGRhdGVWYWx1ZS5mb3JFYWNoKHYgPT4gTWF0aEpheC5IdWIuUXVldWUoKCkgPT4ge1xuICAgICAgICAgIC8vIFN0b3AgcHVzaGluZyBtZXNzYWdlcyB0byB0aGUgcXVldWUgd2hlbiB0aGUgY29tcG9uZW50IGlzIGJlaW5nIGRlc3Ryb3llZC5cbiAgICAgICAgICBpZiAoIXRoaXMuaXNEZXN0cm95aW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gamF4W3Yub3JkZXJdLlRleHQodi52YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSkpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIHRoaXMuaHViU3Vic2NyaXB0aW9uID0gdGhpcy5tYXRoSmF4SHViJFxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIE1hdGhKYXguSHViLlF1ZXVlKFsnVHlwZXNldCcsIE1hdGhKYXguSHViLCB0aGlzLmVsZW1lbnRdKTtcbiAgICAgICAgTWF0aEpheC5IdWIuUXVldWUoWydNYXRoSmF4VHlwZXNldCcsIHRoaXNdKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cGxpY2l0bHkgdHJpZ2dlciB0aGUgTWF0aEpheCB0eXBlc2V0IHByb2Nlc3MuXG4gICAqXG4gICAqIFRoaXMgaXMgdXNlZnVsIGlmIHRoZSBjb250ZW50IGlzIGxvYWRlZCBkeW5hbWljYWxseS5cbiAgICovXG4gIE1hdGhKYXhUeXBlc2V0KCk6IHZvaWQge1xuICAgIHRoaXMubWF0aEpheFR5cGVzZXRTdWJqZWN0Lm5leHQoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IGNoYW5nZXMuTWF0aEpheEV4cHJlc3Npb25zO1xuXG4gICAgLy8gU2hvcnRjdXQgaWYgdGhlcmUncyBub3RoaW5nIHRvIHVwZGF0ZS5cbiAgICBpZiAoIShleHByZXNzaW9ucy5jdXJyZW50VmFsdWUgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgb25seSB0aGUgY2hhbmdlZCBleHByZXNzaW9ucy5cbiAgICBjb25zdCB1cGRhdGVWYWx1ZXM6IFVwZGF0ZVZhbHVlPHN0cmluZz5bXSA9IGV4cHJlc3Npb25zLmN1cnJlbnRWYWx1ZVxuICAgICAgLm1hcCgoY3YsIGkpID0+XG4gICAgICAgIChleHByZXNzaW9ucy5wcmV2aW91c1ZhbHVlID8gZXhwcmVzc2lvbnMucHJldmlvdXNWYWx1ZVtpXSAhPT0gY3YgOiB0cnVlKSA/XG4gICAgICAgICAge1xuICAgICAgICAgICAgdmFsdWU6IGV4cHJlc3Npb25zLmN1cnJlbnRWYWx1ZVtpXSxcbiAgICAgICAgICAgIG9yZGVyOiBpXG4gICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkKVxuICAgICAgLmZpbHRlcih2ID0+IHYpO1xuICAgIHRoaXMuZXhwcmVzc2lvbkNoYW5nZVN1YmplY3QubmV4dCh1cGRhdGVWYWx1ZXMpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5pc0Rlc3Ryb3lpbmcgPSB0cnVlO1xuXG4gICAgdGhpcy5leHByZXNzaW9uQ2hhbmdlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5odWJTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLnR5cGVzZXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcblxuICAgIHRoaXMubWF0aEpheFR5cGVzZXRTdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgdGhpcy5leHByZXNzaW9uQ2hhbmdlU3ViamVjdC5jb21wbGV0ZSgpO1xuICB9XG59XG4iXX0=