import * as tslib_1 from "tslib";
import { Directive, ElementRef, Input } from '@angular/core';
import { combineLatest, ReplaySubject, Subject } from 'rxjs';
import { MathJaxService } from './math-jax.service';
import { map } from 'rxjs/operators';
/**
 * Typeset the content or expressions using MathJax library.
 */
var MathJaxDirective = /** @class */ (function () {
    function MathJaxDirective(el, service) {
        var _this = this;
        /**
         * Observes the change of the input expression.
         */
        this.expressionChangeSubject = new ReplaySubject();
        /**
         * Observes the completion of the initial MathJax typesetting.
         */
        this.mathJaxTypesetSubject = new Subject();
        this.mathJaxHub$ = service.MathJaxHub$;
        this.element = el.nativeElement;
        this.typesetSubscription = combineLatest([this.mathJaxHub$, this.mathJaxTypesetSubject])
            .subscribe(function () {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, _this.element]);
        });
        this.allJax$ = combineLatest([this.mathJaxHub$, this.mathJaxTypesetSubject]).pipe(map(function () { return MathJax.Hub.getAllJax(_this.element); }));
        this.expressionChangeSubscription = combineLatest([this.allJax$, this.expressionChangeSubject])
            .subscribe(function (_a) {
            var _b = tslib_1.__read(_a, 2), jax = _b[0], updateValue = _b[1];
            return updateValue.forEach(function (v) { return MathJax.Hub.Queue(function () {
                // Stop pushing messages to the queue when the component is being destroyed.
                if (!_this.isDestroying) {
                    return jax[v.order].Text(v.value);
                }
            }); });
        });
    }
    MathJaxDirective.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.hubSubscription = this.mathJaxHub$
            .subscribe(function () {
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, _this.element]);
            MathJax.Hub.Queue(['MathJaxTypeset', _this]);
        });
    };
    /**
     * Explicitly trigger the MathJax typeset process.
     *
     * This is useful if the content is loaded dynamically.
     */
    MathJaxDirective.prototype.MathJaxTypeset = function () {
        this.mathJaxTypesetSubject.next();
    };
    MathJaxDirective.prototype.ngOnChanges = function (changes) {
        var expressions = changes.MathJaxExpressions;
        // Shortcut if there's nothing to update.
        if (!(expressions.currentValue instanceof Array)) {
            return;
        }
        // Update only the changed expressions.
        var updateValues = expressions.currentValue
            .map(function (cv, i) {
            return (expressions.previousValue ? expressions.previousValue[i] !== cv : true) ?
                {
                    value: expressions.currentValue[i],
                    order: i
                }
                : undefined;
        })
            .filter(function (v) { return v; });
        this.expressionChangeSubject.next(updateValues);
    };
    MathJaxDirective.prototype.ngOnDestroy = function () {
        this.isDestroying = true;
        this.expressionChangeSubscription.unsubscribe();
        this.hubSubscription.unsubscribe();
        this.typesetSubscription.unsubscribe();
        this.mathJaxTypesetSubject.complete();
        this.expressionChangeSubject.complete();
    };
    tslib_1.__decorate([
        Input('mathjax'),
        tslib_1.__metadata("design:type", Array)
    ], MathJaxDirective.prototype, "MathJaxExpressions", void 0);
    MathJaxDirective = tslib_1.__decorate([
        Directive({
            selector: 'mathjax, [mathjax]'
        }),
        tslib_1.__metadata("design:paramtypes", [ElementRef, MathJaxService])
    ], MathJaxDirective);
    return MathJaxDirective;
}());
export { MathJaxDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aC1qYXguZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW1hdGhqYXgvIiwic291cmNlcyI6WyJzcmMvYXBwL21hdGgtamF4L21hdGgtamF4LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBSUEsT0FBTyxFQUFpQixTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBdUMsTUFBTSxlQUFlLENBQUM7QUFDakgsT0FBTyxFQUFFLGFBQWEsRUFBYyxhQUFhLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUN2RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JDOztHQUVHO0FBSUg7SUE0QkUsMEJBQVksRUFBYyxFQUFFLE9BQXVCO1FBQW5ELGlCQXFCQztRQXRDRDs7V0FFRztRQUNLLDRCQUF1QixHQUFHLElBQUksYUFBYSxFQUF5QixDQUFDO1FBQzdFOztXQUVHO1FBQ2MsMEJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQVcxRCxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDO1FBRWhDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2FBQ3JGLFNBQVMsQ0FBQztZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDNUQsQ0FBQyxDQUFDLENBQUM7UUFFTCxJQUFJLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUs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RUFBRSxDQUFDO0lBQzFDLENBQUM7SUE3RkQ7UUFEQyxLQUFLLENBQUMsU0FBUyxDQUFDOztnRUFDbUI7SUFMekIsZ0JBQWdCO1FBSDVCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxvQkFBb0I7U0FDL0IsQ0FBQztpREE2QmdCLFVBQVUsRUFBVyxjQUFjO09BNUJ4QyxnQkFBZ0IsQ0FtRzVCO0lBQUQsdUJBQUM7Q0FBQSxBQW5HRCxJQW1HQztTQW5HWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBhdXRob3IgZGF2aWRzaGVuODRcbiAqL1xuaW1wb3J0IHsgVXBkYXRlVmFsdWUgfSBmcm9tICcuL2RvbWFpbi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IEFmdGVyVmlld0luaXQsIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgSW5wdXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0LCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE1hdGhKYXhTZXJ2aWNlIH0gZnJvbSAnLi9tYXRoLWpheC5zZXJ2aWNlJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuXG4vKipcbiAqIFR5cGVzZXQgdGhlIGNvbnRlbnQgb3IgZXhwcmVzc2lvbnMgdXNpbmcgTWF0aEpheCBsaWJyYXJ5LlxuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdtYXRoamF4LCBbbWF0aGpheF0nXG59KVxuZXhwb3J0IGNsYXNzIE1hdGhKYXhEaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBpbnB1dCBNYXRoSmF4IGV4cHJlc3Npb25zLlxuICAgKi9cbiAgQElucHV0KCdtYXRoamF4JylcbiAgcHVibGljIE1hdGhKYXhFeHByZXNzaW9uczogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgbWF0aEpheEh1YiQ6IE9ic2VydmFibGU8YW55PjtcbiAgLyoqXG4gICAqIFRoZSBhc3NvY2lhdGVkIG5hdGl2ZSBlbGVtZW50LlxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgLyoqXG4gICAqIE9ic2VydmVzIHRoZSBjaGFuZ2Ugb2YgdGhlIGlucHV0IGV4cHJlc3Npb24uXG4gICAqL1xuICBwcml2YXRlIGV4cHJlc3Npb25DaGFuZ2VTdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8VXBkYXRlVmFsdWU8c3RyaW5nPltdPigpO1xuICAvKipcbiAgICogT2JzZXJ2ZXMgdGhlIGNvbXBsZXRpb24gb2YgdGhlIGluaXRpYWwgTWF0aEpheCB0eXBlc2V0dGluZy5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgbWF0aEpheFR5cGVzZXRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGV4cHJlc3Npb25DaGFuZ2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgLyoqXG4gICAqIE9ic2VydmUgdGhlIHJlYWRpbmVzcyBvZiBhbGwgdGhlIEpheCBpbnN0YW5jZXMgaW4gdGhlIGVsZW1lbnQuXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGFsbEpheCQ6IE9ic2VydmFibGU8YW55W10+O1xuICBwcml2YXRlIHJlYWRvbmx5IHR5cGVzZXRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBodWJTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBpc0Rlc3Ryb3lpbmc6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoZWw6IEVsZW1lbnRSZWYsIHNlcnZpY2U6IE1hdGhKYXhTZXJ2aWNlKSB7XG4gICAgdGhpcy5tYXRoSmF4SHViJCA9IHNlcnZpY2UuTWF0aEpheEh1YiQ7XG4gICAgdGhpcy5lbGVtZW50ID0gZWwubmF0aXZlRWxlbWVudDtcblxuICAgIHRoaXMudHlwZXNldFN1YnNjcmlwdGlvbiA9IGNvbWJpbmVMYXRlc3QoW3RoaXMubWF0aEpheEh1YiQsIHRoaXMubWF0aEpheFR5cGVzZXRTdWJqZWN0XSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICBNYXRoSmF4Lkh1Yi5RdWV1ZShbJ1R5cGVzZXQnLCBNYXRoSmF4Lkh1YiwgdGhpcy5lbGVtZW50XSk7XG4gICAgICB9KTtcblxuICAgIHRoaXMuYWxsSmF4JCA9IGNvbWJpbmVMYXRlc3QoW3RoaXMubWF0aEpheEh1YiQsIHRoaXMubWF0aEpheFR5cGVzZXRTdWJqZWN0XSkucGlwZShcbiAgICAgIG1hcCgoKSA9PiBNYXRoSmF4Lkh1Yi5nZXRBbGxKYXgodGhpcy5lbGVtZW50KSlcbiAgICApO1xuXG4gICAgdGhpcy5leHByZXNzaW9uQ2hhbmdlU3Vic2NyaXB0aW9uID0gY29tYmluZUxhdGVzdChbdGhpcy5hbGxKYXgkLCB0aGlzLmV4cHJlc3Npb25DaGFuZ2VTdWJqZWN0XSlcbiAgICAgIC5zdWJzY3JpYmUoKFtqYXgsIHVwZGF0ZVZhbHVlXSkgPT5cbiAgICAgICAgdXBkYXRlVmFsdWUuZm9yRWFjaCh2ID0+IE1hdGhKYXguSHViLlF1ZXVlKCgpID0+IHtcbiAgICAgICAgICAvLyBTdG9wIHB1c2hpbmcgbWVzc2FnZXMgdG8gdGhlIHF1ZXVlIHdoZW4gdGhlIGNvbXBvbmVudCBpcyBiZWluZyBkZXN0cm95ZWQuXG4gICAgICAgICAgaWYgKCF0aGlzLmlzRGVzdHJveWluZykge1xuICAgICAgICAgICAgcmV0dXJuIGpheFt2Lm9yZGVyXS5UZXh0KHYudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSkpKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmh1YlN1YnNjcmlwdGlvbiA9IHRoaXMubWF0aEpheEh1YiRcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICBNYXRoSmF4Lkh1Yi5RdWV1ZShbJ1R5cGVzZXQnLCBNYXRoSmF4Lkh1YiwgdGhpcy5lbGVtZW50XSk7XG4gICAgICAgIE1hdGhKYXguSHViLlF1ZXVlKFsnTWF0aEpheFR5cGVzZXQnLCB0aGlzXSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBsaWNpdGx5IHRyaWdnZXIgdGhlIE1hdGhKYXggdHlwZXNldCBwcm9jZXNzLlxuICAgKlxuICAgKiBUaGlzIGlzIHVzZWZ1bCBpZiB0aGUgY29udGVudCBpcyBsb2FkZWQgZHluYW1pY2FsbHkuXG4gICAqL1xuICBNYXRoSmF4VHlwZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLm1hdGhKYXhUeXBlc2V0U3ViamVjdC5uZXh0KCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgY29uc3QgZXhwcmVzc2lvbnMgPSBjaGFuZ2VzLk1hdGhKYXhFeHByZXNzaW9ucztcblxuICAgIC8vIFNob3J0Y3V0IGlmIHRoZXJlJ3Mgbm90aGluZyB0byB1cGRhdGUuXG4gICAgaWYgKCEoZXhwcmVzc2lvbnMuY3VycmVudFZhbHVlIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIG9ubHkgdGhlIGNoYW5nZWQgZXhwcmVzc2lvbnMuXG4gICAgY29uc3QgdXBkYXRlVmFsdWVzOiBVcGRhdGVWYWx1ZTxzdHJpbmc+W10gPSBleHByZXNzaW9ucy5jdXJyZW50VmFsdWVcbiAgICAgIC5tYXAoKGN2LCBpKSA9PlxuICAgICAgICAoZXhwcmVzc2lvbnMucHJldmlvdXNWYWx1ZSA/IGV4cHJlc3Npb25zLnByZXZpb3VzVmFsdWVbaV0gIT09IGN2IDogdHJ1ZSkgP1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHZhbHVlOiBleHByZXNzaW9ucy5jdXJyZW50VmFsdWVbaV0sXG4gICAgICAgICAgICBvcmRlcjogaVxuICAgICAgICAgIH1cbiAgICAgICAgICA6IHVuZGVmaW5lZClcbiAgICAgIC5maWx0ZXIodiA9PiB2KTtcbiAgICB0aGlzLmV4cHJlc3Npb25DaGFuZ2VTdWJqZWN0Lm5leHQodXBkYXRlVmFsdWVzKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuaXNEZXN0cm95aW5nID0gdHJ1ZTtcblxuICAgIHRoaXMuZXhwcmVzc2lvbkNoYW5nZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuaHViU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy50eXBlc2V0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG5cbiAgICB0aGlzLm1hdGhKYXhUeXBlc2V0U3ViamVjdC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuZXhwcmVzc2lvbkNoYW5nZVN1YmplY3QuY29tcGxldGUoKTtcbiAgfVxufVxuIl19